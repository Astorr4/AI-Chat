<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RAG –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #0f172a;
            color: #f1f5f9;
            margin: 0;
            padding: 20px;
        }

        h1 {
            margin-bottom: 5px;
        }

        .subtitle {
            opacity: 0.7;
            margin-bottom: 20px;
        }

        .filter-bar {
            margin-bottom: 25px;
        }

        .filter-bar input {
            padding: 5px;
            margin-right: 10px;
        }

        .filter-bar button {
            padding: 6px 12px;
            background: #6366f1;
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
        }

        .kpi-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: #1e293b;
            padding: 16px;
            border-radius: 12px;
            min-width: 180px;
        }

        .kpi-title {
            font-size: 13px;
            opacity: 0.7;
        }

        .kpi-value {
            font-size: 22px;
            margin-top: 6px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .chart-box {
            background: #1e293b;
            padding: 15px;
            border-radius: 12px;
        }

        canvas {
            max-height: 250px;
        }

        .chart-description {
            font-size: 13px;
            opacity: 0.7;
            margin-top: 8px;
        }

        ul {
            padding-left: 20px;
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<h1>üìä RAG –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
<div class="subtitle">
    –ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤.
</div>

<!-- FILTER -->
<div class="filter-bar">
    <label>–°:</label>
    <input type="date" id="fromDate">
    <label>–ü–æ:</label>
    <input type="date" id="toDate">
    <button onclick="loadStats()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
</div>

<!-- KPI -->
<div class="kpi-container">
    <div class="kpi-card">
        <div class="kpi-title">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
        <div class="kpi-value" id="total_requests"></div>
    </div>
    <div class="kpi-card">
        <div class="kpi-title">–ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ–≤</div>
        <div class="kpi-value" id="rejection_rate"></div>
    </div>
    <div class="kpi-card">
        <div class="kpi-title">–°—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
        <div class="kpi-value" id="avg_confidence"></div>
    </div>
    <div class="kpi-card">
        <div class="kpi-title">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (—Å–µ–∫)</div>
        <div class="kpi-value" id="avg_total_time"></div>
    </div>
    <div class="kpi-card">
    <div class="kpi-title">–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (—Å–µ–∫)</div>
    <div class="kpi-value" id="avg_retrieval_time"></div>
    </div>

    <div class="kpi-card">
        <div class="kpi-title">–î–æ–ª—è —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</div>
        <div class="kpi-value" id="followup_rate"></div>
</div>
</div>

<!-- HEALTH SUMMARY -->
<div class="chart-box" style="margin-bottom:25px;">
    <h3>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
    <ul id="healthSummary"></ul>
</div>

<!-- CHARTS -->
<div class="charts-grid">

    <div class="chart-box">
        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</h3>
        <canvas id="confidenceChart"></canvas>
        <div class="chart-description">
            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞—Ö–æ–¥–∏—Ç —Å–∏—Å—Ç–µ–º–∞.
        </div>
    </div>

    <div class="chart-box">
        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞</h3>
        <canvas id="latencyChart"></canvas>
        <div class="chart-description">
            –û–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ (–ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è).
        </div>
    </div>

    <div class="chart-box">
    <h3>–¢–∏–ø—ã –æ—Ç–∫–∞–∑–æ–≤</h3>

    <p class="chart-description">
        –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–∫–∞–∑–∞–ª–∞—Å—å
        —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç.
        <br>
        –û—Ç–∫–∞–∑ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–ª—É—á–∞—è—Ö, –∫–æ–≥–¥–∞ —Å–∏—Å—Ç–µ–º–∞ —Å—á–∏—Ç–∞–µ—Ç,
        —á—Ç–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
        –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π –∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.
        <br><br>
        –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
        <br><br>
            <b>threshold</b> ‚Äî –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–π score.<br>
            <b>self_check:low_keyword_coverage</b> ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤.<br>
            <b>self_check:numeric_mismatch</b> ‚Äî –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —á–∏—Å–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö.<br>
            <b>verification_invalid</b> ‚Äî –º–æ–¥–µ–ª—å –ø–æ—Å—á–∏—Ç–∞–ª–∞ –æ—Ç–≤–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.<br>
            <b>no_results</b> ‚Äî –ø–æ –∑–∞–ø—Ä–æ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.<br>
    </p>

    <canvas id="rejectionChart"></canvas>
</div>

    <div class="chart-box">
        <h3>–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ vs –í—Ä–µ–º—è LLM</h3>
        <canvas id="scatterChart"></canvas>
        <div class="chart-description">
            –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
        </div>
    </div>

    <div class="chart-box">
    <h3>–¢—Ä–µ–Ω–¥ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</h3>

    <p class="chart-description">
        –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∏–Ω–∞–º–∏–∫—É —Å—Ä–µ–¥–Ω–µ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è <b>confidence</b> –ø–æ –¥–Ω—è–º.
        <br><br>
        Confidence ‚Äî —ç—Ç–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã.
        –†–æ—Å—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≥–æ–≤–æ—Ä–∏—Ç –æ —Å—Ç–∞–±–∏–ª—å–Ω–æ–π –∏ —Ç–æ—á–Ω–æ–π —Ä–∞–±–æ—Ç–µ retrieval,
        —Å–Ω–∏–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
        –∏–ª–∏ —É—Ö—É–¥—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞.
    </p>

    <canvas id="confidenceTrendChart"></canvas>
</div>

</div>

<script>

const chartInstances = {};

function destroyChart(id) {
    if (chartInstances[id]) {
        chartInstances[id].destroy();
        delete chartInstances[id];
    }
}

async function loadStats() {

    const from = document.getElementById("fromDate").value;
    const to = document.getElementById("toDate").value;

    let url = "/rag-stats";
    if (from && to) {
        url += `?from_date=${from}&to_date=${to}`;
    }

    const response = await fetch(url);
    const data = await response.json();
    const agg = data.aggregates;

    // =========================
    // KPI
    // =========================

    document.getElementById("total_requests").innerText =
        agg.total_requests;

    document.getElementById("rejection_rate").innerText =
        (agg.rejection_rate * 100).toFixed(1) + "%";

    document.getElementById("avg_confidence").innerText =
        agg.avg_confidence.toFixed(3);

    document.getElementById("avg_total_time").innerText =
        agg.avg_total_time.toFixed(2);

    // –ù–æ–≤—ã–π KPI: Avg Retrieval
    if (document.getElementById("avg_retrieval_time")) {
        document.getElementById("avg_retrieval_time").innerText =
            (data.avg_retrieval_time || 0).toFixed(2);
    }

    // –ù–æ–≤—ã–π KPI: Follow-up rate
    if (document.getElementById("followup_rate")) {
        document.getElementById("followup_rate").innerText =
            ((data.followup_rate || 0) * 100).toFixed(1) + "%";
    }

    // =========================
    // Health summary
    // =========================

    updateHealth(data.health_summary);

    // =========================
    // –ì–†–ê–§–ò–ö–ò
    // =========================

    createBarChart("confidenceChart",
        data.confidence_distribution);

    createBarChart("latencyChart",
        data.latency_distribution);

    createPieChart("rejectionChart",
        data.rejection_types);

    createScatterChart("scatterChart",
        data.scatter_data);

    // =========================
    // –ù–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫: Confidence Trend
    // =========================
    if (data.confidence_trend &&
        document.getElementById("confidenceTrendChart")) {

        createConfidenceTrendChart(
            "confidenceTrendChart",
            data.confidence_trend
        );
    }
}

function updateHealth(list) {
    const ul = document.getElementById("healthSummary");
    ul.innerHTML = "";
    list.forEach(item => {
        const li = document.createElement("li");
        li.innerText = item;
        ul.appendChild(li);
    });
}

function createBarChart(id, dataset) {
    destroyChart(id);
    const ctx = document.getElementById(id).getContext("2d");
    chartInstances[id] = new Chart(ctx, {
        type: "bar",
        data: {
            labels: Object.keys(dataset),
            datasets: [{
                data: Object.values(dataset),
                backgroundColor: "#6366f1"
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            responsive: true,
            maintainAspectRatio: false,
        }
    });
}

function createPieChart(id, dataset) {
    destroyChart(id);
    const ctx = document.getElementById(id).getContext("2d");
    chartInstances[id] = new Chart(ctx, {
        type: "pie",
        data: {
            labels: Object.keys(dataset),
            datasets: [{
                data: Object.values(dataset),
                backgroundColor: ["#ef4444", "#f59e0b", "#6366f1", "#10b981"]
            }]
        }
    });
}

function createScatterChart(id, dataset) {
    destroyChart(id);
    const ctx = document.getElementById(id).getContext("2d");
    chartInstances[id] = new Chart(ctx, {
        type: "scatter",
        data: {
            datasets: [{
                label: "Context vs LLM Time",
                data: dataset,
                backgroundColor: "#6366f1"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
        }
    });
}

loadStats();

function createConfidenceTrendChart(id, dataset) {

    if (!dataset || dataset.length === 0) {
        console.log("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç—Ä–µ–Ω–¥–∞");
        return;
    }

    const canvas = document.getElementById(id);
    if (!canvas) return;

    const ctx = canvas.getContext("2d");

    destroyChart(id);

    chartInstances[id] = new Chart(ctx, {
        type: "line",
        data: {
            labels: dataset.map(d => d.date),
            datasets: [{
                label: "–°—Ä–µ–¥–Ω–∏–π Confidence",
                data: dataset.map(d => d.value),
                borderColor: "#6366f1",
                backgroundColor: "rgba(99,102,241,0.2)",
                tension: 0.3,
                fill: true,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 0,
                    max: 1
                }
            }
        }
    });
}

</script>

</body>
</html>
